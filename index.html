<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ğŸ‘¨â€ğŸŒ¾ ì˜¥íƒ‘ë°­ íšŒì›ê´€ë¦¬ (í…ƒë°­ì§€ê¸°ìš©)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="color-scheme" content="light dark" />
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
  <style>
    .card{transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-2px)}
    input, select, button { outline: none; }
    /* ê²Œì´íŠ¸ê°€ ëœ¨ë©´ ë’¤ í™”ë©´ì´ ì™„ì „íˆ ë³´ì´ì§€ ì•Šë„ë¡ ë¶ˆíˆ¬ëª… ë°°ê²½ */
    .backdrop { background: rgba(0,0,0,0.96); }
  </style>
</head>
<body class="min-h-screen bg-slate-50 dark:bg-slate-900 text-slate-900 dark:text-slate-100">
  <!-- ë¹„ë°€ë²ˆí˜¸ ê²Œì´íŠ¸: ì²˜ìŒì—” ë³´ì´ê³ , í†µê³¼í•˜ë©´ ìˆ¨ê¹€ -->
  <div id="pwGate" class="fixed inset-0 flex items-center justify-center p-6 backdrop z-50">
    <div class="w-full max-w-md rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-xl p-6">
      <h2 class="text-xl font-semibold">ğŸ”’ ì ‘ê·¼ ë¹„ë°€ë²ˆí˜¸</h2>
      <p class="mt-2 text-sm text-slate-500 dark:text-slate-400">ì ‘ì† ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</p>
      <form id="pwForm" class="mt-4 space-y-3">
        <input id="pwInput" type="password" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="current-password" />
        <div class="flex items-center justify-between">
          <label class="inline-flex items-center gap-2 text-sm"><input id="rememberSession" type="checkbox" class="rounded"> ì´ ì„¸ì…˜ì—ì„œ ê¸°ì–µ</label>
          <div class="text-xs text-slate-500">íŒíŠ¸: ê´€ë¦¬ìš©</div>
        </div>
        <div class="flex gap-2 justify-end pt-2">
          <button type="submit" class="rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2">ì…ì¥</button>
        </div>
        <p id="pwError" class="hidden text-sm text-red-600">ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
      </form>
    </div>
  </div>

  <!-- ì‹¤ì œ ì•± ì½˜í…ì¸ ë¥¼ ë˜í•‘í•´ì„œ, ê²Œì´íŠ¸ í†µê³¼ ì „ì—ëŠ” ìˆ¨ê¹€ -->
  <div id="appContent" class="hidden">
    <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
    <div id="confirmModal" class="fixed inset-0 hidden items-center justify-center p-6 backdrop z-40">
      <div class="w-full max-w-md rounded-2xl border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-800 shadow-xl p-6">
        <h3 class="text-lg font-semibold">ì „ì²´ ì‚­ì œ</h3>
        <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">
          ì „ì²´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ë ¤ë©´ ì•„ë˜ ì…ë ¥ì¹¸ì— <b>ì •ë§ ì§€ìš¸ê±°ì—ìš”</b> ë¥¼ ê·¸ëŒ€ë¡œ ì…ë ¥í•˜ì„¸ìš”.
        </p>
        <input id="confirmInput" class="mt-4 w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900" placeholder="ì •ë§ ì§€ìš¸ê±°ì—ìš”" />
        <div class="mt-4 flex items-center justify-end gap-2">
          <button id="cancelDelete" class="rounded-xl border px-4 py-2 border-slate-300 dark:border-slate-700">ì·¨ì†Œ</button>
          <button id="doDelete" class="rounded-xl bg-red-600 text-white px-4 py-2 opacity-50 cursor-not-allowed" disabled>ì‚­ì œ</button>
        </div>
      </div>
    </div>

    <header class="max-w-5xl mx-auto px-4 py-6">
      <h1 class="text-2xl sm:text-3xl font-semibold">ğŸ‘¨â€ğŸŒ¾ ì˜¥íƒ‘ë°­ íšŒì›ê´€ë¦¬ (í…ƒë°­ì§€ê¸° ì „ìš©)</h1>
      <p class="text-sm text-slate-500 dark:text-slate-400">ì™„ì „ ì •ì  Â· ë°ì´í„°ëŠ” ë¸Œë¼ìš°ì € <b>localStorage</b>ì— ì €ì¥ë©ë‹ˆë‹¤.</p>
      <div class="mt-3 flex flex-wrap gap-2">
        <button id="exportCsvBtn" class="rounded-xl border px-3 py-2 text-sm border-slate-300 dark:border-slate-700">CSV ë‚´ë³´ë‚´ê¸°</button>
        <label class="rounded-xl border px-3 py-2 text-sm border-slate-300 dark:border-slate-700 cursor-pointer">
          CSV ê°€ì ¸ì˜¤ê¸°<input id="importCsvInput" type="file" accept=".csv,text/csv" class="hidden" />
        </label>
      </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 pb-12 space-y-6">

      <!-- ì‹ ê·œ ë“±ë¡ -->
      <section class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/60 shadow-sm p-5">
        <h2 class="text-lg font-semibold mb-3">ì‹ ê·œ íšŒì› ë“±ë¡</h2>
        <form id="addForm" class="grid grid-cols-1 sm:grid-cols-6 gap-3 items-end">
          <div class="sm:col-span-2">
            <label class="block text-sm mb-1">ì´ë¦„*</label>
            <input required name="name" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="í™ê¸¸ë™" />
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm mb-1">ì—°ë½ì²˜</label>
            <input name="phone" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="010-0000-0000" />
          </div>
          <div>
            <label class="block text-sm mb-1">ë©¤ë²„ì‹­</label>
            <select name="membership_type" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800">
              <option value="monthly">ì›”ê°„</option>
              <option value="quarterly">ë¶„ê¸°</option>
              <option value="yearly">ì—°ê°„</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">ì‹œì‘ì¼</label>
            <input type="date" name="start_date" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" />
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm mb-1">ë§Œë£Œì¼ (ë¯¸ì§€ì • ì‹œ ìë™)</label>
            <input type="date" name="expiry_date" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" />
          </div>
          <div class="sm:col-span-1">
            <button class="w-full rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2">ë“±ë¡</button>
          </div>
        </form>
      </section>

      <!-- í•„í„° -->
      <section class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/60 shadow-sm p-5">
        <form id="filterForm" class="grid grid-cols-1 sm:grid-cols-5 gap-3">
          <div class="sm:col-span-2">
            <label class="block text-sm mb-1">ê²€ìƒ‰ (ì´ë¦„/ì—°ë½ì²˜)</label>
            <input name="q" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800" placeholder="í™ê¸¸ë™, 010..." />
          </div>
          <div>
            <label class="block text-sm mb-1">ìƒíƒœ</label>
            <select name="status" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800">
              <option value="all">ì „ì²´</option>
              <option value="active">í™œì„±</option>
              <option value="expired">ë§Œë£Œ</option>
            </select>
          </div>
          <div>
            <label class="block text-sm mb-1">ë©¤ë²„ì‹­</label>
            <select name="mtype" class="w-full rounded-xl border px-3 py-2 border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800">
              <option value="all">ì „ì²´</option>
              <option value="monthly">ì›”ê°„</option>
              <option value="quarterly">ë¶„ê¸°</option>
              <option value="yearly">ì—°ê°„</option>
            </select>
          </div>
          <div class="sm:self-end">
            <button class="w-full rounded-xl border px-4 py-2 border-slate-300 dark:border-slate-700">í•„í„° ì ìš©</button>
          </div>
        </form>
      </section>

      <!-- ëª©ë¡ -->
      <section class="rounded-2xl border border-slate-200 dark:border-slate-700 bg-white/80 dark:bg-slate-800/60 shadow-sm p-5 overflow-x-auto">
        <table class="w-full text-sm" id="membersTable">
          <thead class="text-left text-slate-500 dark:text-slate-400">
            <tr>
              <th class="py-2 pr-3">#</th>
              <th class="py-2 pr-3">ì´ë¦„</th>
              <th class="py-2 pr-3">ì—°ë½ì²˜</th>
              <th class="py-2 pr-3">ë©¤ë²„ì‹­</th>
              <th class="py-2 pr-3">ì‹œì‘ì¼</th>
              <th class="py-2 pr-3">ë§Œë£Œì¼</th>
              <th class="py-2 pr-3">ìƒíƒœ</th>
              <th class="py-2 pr-3 text-right">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody id="membersBody" class="align-top"></tbody>
        </table>
        <div id="emptyHint" class="py-6 text-center text-slate-500 dark:text-slate-400 hidden">íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>
      </section>
    </main>

    <footer class="max-w-5xl mx-auto px-4 py-8 text-xs text-slate-500 dark:text-slate-400 flex items-center justify-between">
      <p>Â© <span id="year"></span> ì˜¥íƒ‘ë°­ Â· otoba</p>
      <button id="footerClearBtn" class="underline hover:no-underline text-red-600">ì „ì²´ ì‚­ì œ</button>
    </footer>
  </div>

  <script>
    // ---------- Password Gate ----------
    const PW = '@data2022';
    const sessionKey = 'otobap_pw_ok';
    const pwGate = document.getElementById('pwGate');
    const appContent = document.getElementById('appContent');
    const pwInput = document.getElementById('pwInput');
    const pwForm = document.getElementById('pwForm');
    const pwErr = document.getElementById('pwError');
    const rememberSession = document.getElementById('rememberSession');

    function openGate(){
      // gate visible, app hidden
      pwGate.classList.add('flex');
      pwGate.classList.remove('hidden');
      appContent.classList.add('hidden');
      setTimeout(()=>pwInput.focus(), 30);
    }
    function closeGate(){
      pwGate.classList.add('hidden');
      pwGate.classList.remove('flex');
      appContent.classList.remove('hidden');
    }

    // initial state
    if (sessionStorage.getItem(sessionKey) === '1') {
      closeGate();
    } else {
      openGate();
    }

    pwForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      if(pwInput.value === PW){
        if(rememberSession.checked){
          sessionStorage.setItem(sessionKey, '1');
        }
        pwErr.classList.add('hidden');
        closeGate();
      }else{
        pwErr.classList.remove('hidden');
        pwInput.select();
      }
    });

    // ---------- Storage & Utils ----------
    const STORAGE_KEY = 'otobap_members_v1';
    const DURATIONS = { monthly: 1, quarterly: 3, yearly: 12 };
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    function fmt(d){
      if(!d) return '';
      const dt = new Date(d);
      if(Number.isNaN(dt.getTime())) return '';
      return dt.toISOString().slice(0,10);
    }
    function addMonths(date, n){
      const d = new Date(date);
      const day = d.getDate();
      d.setMonth(d.getMonth()+n);
      if(d.getDate() !== day){ d.setDate(0); }
      return d;
    }
    function calcExpiry(start, membership_type){
      const months = DURATIONS[membership_type] || 1;
      return addMonths(start, months);
    }
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : { seq: 0, rows: [] };
      }catch(e){ return { seq: 0, rows: [] }; }
    }
    function save(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function statusOf(expiry){
      const today = new Date(); today.setHours(0,0,0,0);
      const ed = new Date(expiry); ed.setHours(0,0,0,0);
      return ed < today ? 'expired' : 'active';
    }
    function toCSV(rows){
      const header = ['id','name','phone','membership_type','start_date','expiry_date'];
      const lines = [header.join(',')];
      for(const r of rows){
        const vals = [r.id, r.name, r.phone || '', r.membership_type, fmt(r.start_date), fmt(r.expiry_date)];
        lines.push(vals.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
      }
      return lines.join('\n');
    }
    function parseCSV(text){
      const lines = text.trim().split(/\r?\n/);
      const header = lines.shift();
      const cols = header.split(',').map(s=>s.replace(/^"|"$/g,''));
      const idx = {}; cols.forEach((c,i)=>idx[c]=i);
      const rows = [];
      for(const line of lines){
        const cells = [];
        let cur = '', inside=false;
        for(let i=0;i<line.length;i++){
          const ch=line[i];
          if(ch=='"'){
            if(inside && line[i+1]=='"'){ cur+='"'; i++; }
            else inside=!inside;
          }else if(ch==',' && !inside){
            cells.push(cur); cur='';
          }else{ cur+=ch; }
        }
        cells.push(cur);
        const get = (k)=> (cells[idx[k]]||'').replace(/^"|"$/g,'');
        rows.push({
          id: Number(get('id')) || 0,
          name: get('name'),
          phone: get('phone')||null,
          membership_type: get('membership_type')||'monthly',
          start_date: get('start_date')||fmt(new Date()),
          expiry_date: get('expiry_date')||fmt(new Date())
        });
      }
      return rows;
    }

    // ---------- Render ----------
    function render(){
      const st = load();
      const tbody = $('#membersBody');
      tbody.innerHTML = '';
      const form = $('#filterForm');
      const q = (form.q.value || '').trim().toLowerCase();
      const status = form.status.value;
      const mtype = form.mtype.value;

      let rows = st.rows.slice().sort((a,b)=>b.id-a.id);

      if(q){
        rows = rows.filter(r => (r.name||'').toLowerCase().includes(q) || (r.phone||'').toLowerCase().includes(q));
      }
      if(['monthly','quarterly','yearly'].includes(mtype)){
        rows = rows.filter(r => r.membership_type === mtype);
      }
      if(status==='active'){
        rows = rows.filter(r => statusOf(r.expiry_date)==='active');
      }else if(status==='expired'){
        rows = rows.filter(r => statusOf(r.expiry_date)==='expired');
      }

      if(rows.length === 0){
        $('#emptyHint').classList.remove('hidden');
      }else{
        $('#emptyHint').classList.add('hidden');
      }

      for(const r of rows){
        const tr = document.createElement('tr');
        tr.className = 'border-t border-slate-200 dark:border-slate-700';
        tr.innerHTML = `
          <td class="py-2 pr-3">${r.id}</td>
          <td class="py-2 pr-3 font-medium">${r.name||''}</td>
          <td class="py-2 pr-3">${r.phone||'-'}</td>
          <td class="py-2 pr-3">
            ${r.membership_type==='monthly'?'ì›”ê°„':r.membership_type==='quarterly'?'ë¶„ê¸°':r.membership_type==='yearly'?'ì—°ê°„':r.membership_type}
          </td>
          <td class="py-2 pr-3">${fmt(r.start_date)}</td>
          <td class="py-2 pr-3">${fmt(r.expiry_date)}</td>
          <td class="py-2 pr-3">
            ${
              statusOf(r.expiry_date)==='expired'
              ? '<span class="inline-flex items-center rounded-lg bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-200 px-2 py-1 text-xs">ë§Œë£Œ</span>'
              : '<span class="inline-flex items-center rounded-lg bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-200 px-2 py-1 text-xs">í™œì„±</span>'
            }
          </td>
          <td class="py-2 pr-3 text-right">
            <button data-id="${r.id}" class="delBtn rounded-lg border px-3 py-1 text-xs border-slate-300 dark:border-slate-700 hover:bg-slate-100 dark:hover:bg-slate-700">ì‚­ì œ</button>
          </td>
        `;
        tbody.appendChild(tr);
      }

      document.querySelectorAll('.delBtn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = Number(e.currentTarget.getAttribute('data-id'));
          if(!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
          const st = load();
          st.rows = st.rows.filter(r=>r.id!==id);
          save(st);
          render();
        }, { once: true });
      });
    }

    // ---------- Events ----------
    document.getElementById('year').textContent = new Date().getFullYear();

    document.getElementById('addForm')?.addEventListener('submit', (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const name = (fd.get('name')||'').trim();
      if(!name){ alert('ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
      const phone = (fd.get('phone')||'').trim() || null;
      const membership_type = fd.get('membership_type')||'monthly';
      const start_date = fd.get('start_date') || fmt(new Date());
      let expiry_date = fd.get('expiry_date');
      if(!expiry_date){
        expiry_date = fmt(calcExpiry(start_date, membership_type));
      }
      const st = load();
      const id = (st.seq||0)+1;
      st.seq = id;
      st.rows.push({ id, name, phone, membership_type, start_date, expiry_date });
      save(st);
      e.target.reset();
      render();
    });

    document.getElementById('filterForm')?.addEventListener('submit',(e)=>{
      e.preventDefault();
      render();
    });

    document.getElementById('exportCsvBtn')?.addEventListener('click', ()=>{
      const st = load();
      const csv = toCSV(st.rows);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'members_export.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    document.getElementById('importCsvInput')?.addEventListener('change', (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const rows = parseCSV(reader.result);
          const st = load();
          let maxId = st.seq || 0;
          for(const r of rows){ maxId = Math.max(maxId, r.id||0); }
          st.seq = maxId;
          const existingIds = new Set(st.rows.map(r=>r.id));
          for(const r of rows){
            if(existingIds.has(r.id)){ maxId += 1; r.id = maxId; }
            st.rows.push(r);
          }
          save(st);
          render();
          alert('CSV ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ');
        }catch(err){
          console.error(err);
          alert('CSV íŒŒì‹± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      };
      reader.readAsText(file, 'utf-8');
      e.target.value = '';
    });

    // Footer clear -> modal
    const footerClearBtn = document.getElementById('footerClearBtn');
    const confirmModal = document.getElementById('confirmModal');
    const confirmInput = document.getElementById('confirmInput');
    const doDelete = document.getElementById('doDelete');
    const cancelDelete = document.getElementById('cancelDelete');
    const magicPhrase = 'ì •ë§ ì§€ìš¸ê±°ì—ìš”';

    footerClearBtn?.addEventListener('click', ()=>{
      confirmModal.classList.remove('hidden');
      confirmModal.classList.add('flex');
      confirmInput.value='';
      doDelete.disabled = true;
      doDelete.classList.add('opacity-50','cursor-not-allowed');
      setTimeout(()=>confirmInput.focus(), 50);
    });
    cancelDelete?.addEventListener('click', ()=>{
      confirmModal.classList.add('hidden');
      confirmModal.classList.remove('flex');
    });
    confirmInput?.addEventListener('input', ()=>{
      const ok = confirmInput.value.trim() === magicPhrase;
      doDelete.disabled = !ok;
      doDelete.classList.toggle('opacity-50', !ok);
      doDelete.classList.toggle('cursor-not-allowed', !ok);
    });
    doDelete?.addEventListener('click', ()=>{
      const st = { seq: 0, rows: [] };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(st));
      confirmModal.classList.add('hidden');
      confirmModal.classList.remove('flex');
      render();
      alert('ì „ì²´ ì‚­ì œ ì™„ë£Œ');
    });

    // ì´ˆê¸° ë Œë” (ê²Œì´íŠ¸ í†µê³¼ í›„ì—ë§Œ ë³´ì´ì§€ë§Œ, ìƒíƒœ ê³„ì‚°ì„ ìœ„í•´ í˜¸ì¶œ)
    render();
  </script>
</body>
</html>
